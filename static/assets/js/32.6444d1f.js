(window.webpackJsonp=window.webpackJsonp||[]).push([[32],{"+aVv":function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=f(n("4d7F")),i=f(n("gDS+")),a=f(n("14Xm")),s=f(n("D3Ub")),r=f(n("vDqi")),c=f(n("BEWh")),d=f(n("PaSM")),l=n("q7Rq"),u=n("CeR/");function f(e){return e&&e.__esModule?e:{default:e}}t.default={name:"ProjectServiceSla",components:{secondFlow:c.default},mixins:[d.default],props:{modelPriority:{type:Array,default:function(){return[]}}},data:function(){return{serviceLoading:!0,serviceData:{},slaListLoading:!0,slaList:[],isSlaActive:!1,nodeOption:[],endNodeOption:[],agreementEditData:{},isNodeClick:!1,serviceAgreementIsShow:!1,viewAgreementIsShow:!1,endNodeSelectLoading:!1,addList:[],lineList:[],canvasDataLoading:!1,previewInfo:{canClick:!1,narrowSize:.9},submitPending:!1,agreementRules:{start_node_id:[{message:"字段必填",required:!0,trigger:"blur",validator:function(e){return!!e}}],end_node_id:[{message:"字段必填",required:!0,trigger:"blur",validator:function(e){return!!e}}],sla_id:[{message:"字段必填",required:!0,trigger:"blur",validator:function(e){return!!e}}]},agreeType:"add",isStartSla:!0,processTools:null}},computed:{getTransitionLines:function(){return{from_state:this.agreementEditData.start_node_id,to_state:this.agreementEditData.end_node_id}}},watch:{getTransitionLines:function(e){var t=this;if(e.from_state&&e.to_state){var n={id:this.serviceData.workflow,from_state_id:e.from_state,to_state_id:e.to_state};this.$store.dispatch("workflowVersion/getTransitionLines",n).then((function(e){t.agreementEditData.lines=e.data.lines,t.agreementEditData.states=e.data.states})).catch((function(e){(0,u.errorHandler)(e,t)}))}}},mounted:function(){this.initData()},methods:{initData:function(){var e=this;return(0,s.default)(a.default.mark((function t(){return a.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.getSlaList(),t.next=3,e.getServiceDetail();case 3:e.getWorkflowCanvasData();case 4:case"end":return t.stop()}}),t,e)})))()},getServiceDetail:function(){var e=this;return this.serviceLoading=!0,this.$store.dispatch("service/getServiceDetail",this.$route.params.id).then((function(t){e.serviceData=t.data,t.data.sla.length>0&&(e.isSlaActive=!0)})).catch((function(t){(0,u.errorHandler)(t,e)})).finally((function(){e.serviceLoading=!1}))},getSlaList:function(){var e=this;this.slaListLoading=!0;var t={is_enabled:!0,project_key:this.$store.state.project.id};this.$store.dispatch("slaManagement/getProtocolsList",{params:t}).then((function(t){e.slaList=t.data})).catch((function(t){(0,u.errorHandler)(t,e)})).finally((function(){e.slaListLoading=!1}))},getWorkflowCanvasData:function(){var e=this;this.canvasDataLoading=!0,r.default.all([this.$store.dispatch("deployCommon/getNodeVersion",{id:this.serviceData.workflow}),this.$store.dispatch("deployCommon/getLineVersion",{id:this.serviceData.workflow})]).then(r.default.spread((function(t,n){e.addList=t.data;for(var o=0;o<e.addList.length;o++)e.addList[o].indexInfo=o;e.$store.commit("cdeploy/getChart",e.addList),e.lineList=n.data.items,e.nodeOption=t.data.filter((function(e){return""!==e.name&&"START"!==e.type&&"END"!==e.type})),e.processTools=new l.ProcessTools(e.addList,e.lineList)}))).finally((function(){e.canvasDataLoading=!1}))},getPostNodes:function(e){var t=this.processTools.getSlaAfterNodes(e);this.endNodeOption=t},getProtocolName:function(e){var t=this.slaList.find((function(t){return t.id===e}));if(t&&t.name)return e&&t.name},handleSetAgreement:function(){var e=this;this.$refs.agreementForm.validate().then((function(t){e.isNodeClick||"add"!==e.agreeType||e.serviceData.sla.push(e.agreementEditData),e.isNodeClick=!1,e.serviceAgreementIsShow=!1}))},agreementTextClick:function(e,t){this.agreeType=t||"add",this.agreementEditData=e,this.serviceAgreementIsShow=!0,this.endNodeOption=[],e.color||this.$set(this.agreementEditData,"color",this.getRendomColor()),this.agreementEditData.start_node_id&&this.getPostNodes(this.agreementEditData.start_node_id),this.isNodeClick=!1},nodeCheck:function(e){var t=e.start_node_id===e.end_node_id;return t&&this.$bkMessage({message:this.$t("m.serviceConfig['添加协议失败，请重新选择正确结束节点！']"),theme:"error",ellipsisLine:0}),t},agreementCloseClick:function(e,t){var n=this;this.$bkInfo({extCls:"agreement-close",type:"warning",title:this.getProtocolName(e.sla_id)?this.$t('m.serviceConfig["确认删除服务协议"]')+"<"+this.getProtocolName(e.sla_id)+">":this.$t('m["当前服务协议配置未完成，确认要删除吗？"]'),confirmFn:function(){var e=n.serviceData.sla.length-1;e!==t||n.serviceData.sla[e].end_node_id||(n.isStartSla=!0,n.isNodeClick=!1),n.serviceData.sla.splice(t,1)}})},configuNode:function(e){var t=this.serviceData.sla;if(this.isStartSla)t.push({start_node_id:e.id,color:this.getRendomColor()});else{var n=t.length-1,o=t[n];if(!this.processTools.getSlaAfterNodes(o.start_node_id).find((function(t){return t.id===e.id})))return this.$bkMessage({message:"该节点不能作为 SLA 结束节点",theme:"error",ellipsisLine:0}),!1;if(o.end_node_id=e.id,this.$set(t,n,t[n]),this.nodeCheck(t[n]))return void(t[n].end_node_id="");this.agreementTextClick(t[n]),this.isNodeClick=!0}this.isStartSla=!this.isStartSla},getRendomColor:function(){var e=0,t="#",n=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"];for(e=0;e<6;e++)t+=n[parseInt(16*Math.random())];return"#FFFFFF"===t&&(t="#87cb12"),t},submitFn:function(){var e=this,t=this.serviceData,n=t.can_ticket_agency,o=t.catalog_id,i=t.desc,a=t.display_type,s=t.id,r=t.is_valid,c=t.key,d=t.name,l=t.owners,f={can_ticket_agency:n,catalog_id:o,desc:i,display_type:a,id:s,is_valid:r,key:c,name:d,owners:l,sla:t.sla,workflow:t.workflow,admin:l.split(","),project_key:this.$store.state.project.id};if(this.isSlaActive){if(!f.sla.length)return void this.$bkMessage({message:this.$t('m.deployPage["请添加SLA协议！"]'),theme:"error"});f.sla=f.sla.map((function(t){return t.name=e.getProtocolName(t.sla_id),t}))}else f.sla=[];this.submitPending||(this.submitPending=!0,this.$store.dispatch("serviceEntry/updateService",f).then((function(t){e.$bkMessage({message:e.$t('m.deployPage["保存成功"]'),theme:"success"}),e.goToServiceList()})).catch((function(t){(0,u.errorHandler)(t,e)})).finally((function(){e.submitPending=!1})))},goToServiceList:function(){this.$router.push({name:"projectServiceList",query:{project_id:this.$route.query.project_id,catalog_id:this.$route.query.catalog_id}})},handleCreateAgreement:function(){var e=this.$router.resolve({path:"/project/sla_agreement",query:{project_id:this.$store.state.project.id}});window.open(e.href,"_blank")},handleEditAgreement:function(e){var t=this.$router.resolve({path:"/project/sla_agreement",query:{project_id:this.$store.state.project.id,item:(0,i.default)(e)}});window.open(t.href,"_blank")},submitInfo:function(){var e=this;return(0,s.default)(a.default.mark((function t(){return a.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:e.$refs.dynamicForm.validate().then((function(e){}),(function(t){e.$parent.$refs.agreement.scrollTop=0}));case 1:case"end":return t.stop()}}),t,e)})))()},handleCancelAgreement:function(){this.serviceAgreementIsShow=!1,this.clearLastNode()},clearLastNode:function(){return this.isNodeClick&&"add"===this.agreeType&&this.serviceData.sla.pop(),!0},handleUseSlaPreCheck:function(e){var t=this;return!e||(this.serviceData.workflow?new o.default((function(e,n){t.$store.dispatch("sla/checkProcessCanUseSla",t.serviceData.workflow).then((function(t){e(t.result)})).catch((function(e){(0,u.errorHandler)(e,t),n(e)}))})):(this.$bkMessage({message:this.$t("m.serviceConfig['请选择流程版本']"),theme:"error"}),!1))}}}},"/lN2":function(e,t,n){"use strict";n("R1Rv")},"0nTK":function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=f(n("P2sY")),i=f(n("gDS+")),a=f(n("jWXv")),s=f(n("FyfS")),r=f(n("JO7F")),c=f(n("nLf9")),d=f(n("GQeE")),l=f(n("SEkw")),u=n("4ZMo");function f(e){return e&&e.__esModule?e:{default:e}}function h(e,t,n){return t in e?(0,l.default)(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function p(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},o=(0,d.default)(n);"function"==typeof c.default&&(o=o.concat((0,c.default)(n).filter((function(e){return(0,r.default)(n,e).enumerable})))),o.forEach((function(t){h(e,t,n[t])}))}return e}var v=function(e,t,n,o,i,a,s,r,c,d){"boolean"!=typeof s&&(c=r,r=s,s=!1);var l,u="function"==typeof n?n.options:n;if(e&&e.render&&(u.render=e.render,u.staticRenderFns=e.staticRenderFns,u._compiled=!0,i&&(u.functional=!0)),o&&(u._scopeId=o),a?(l=function(e){(e=e||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(e=__VUE_SSR_CONTEXT__),t&&t.call(this,c(e)),e&&e._registeredComponents&&e._registeredComponents.add(a)},u._ssrRegister=l):t&&(l=s?function(){t.call(this,d(this.$root.$options.shadowRoot))}:function(e){t.call(this,r(e))}),l)if(u.functional){var f=u.render;u.render=function(e,t){return l.call(t),f(e,t)}}else{var h=u.beforeCreate;u.beforeCreate=h?[].concat(h,l):[l]}return n},m="undefined"!=typeof navigator&&/msie [6-9]\\b/.test(navigator.userAgent.toLowerCase()),g=document.head||document.getElementsByTagName("head")[0],y={},w=function(e){return function(e,t){return function(e,t){var n=m?t.media||"default":e,o=y[n]||(y[n]={ids:new a.default,styles:[]});if(!o.ids.has(e)){o.ids.add(e);var s=t.source;if(t.map&&(s+="\n/*# sourceURL="+t.map.sources[0]+" */",s+="\n/*# sourceMappingURL=data:application/json;base64,"+btoa(unescape(encodeURIComponent((0,i.default)(t.map))))+" */"),o.element||(o.element=document.createElement("style"),o.element.type="text/css",t.media&&o.element.setAttribute("media",t.media),g.appendChild(o.element)),"styleSheet"in o.element)o.styles.push(s),o.element.styleSheet.cssText=o.styles.filter(Boolean).join("\n");else{var r=o.ids.size-1,c=document.createTextNode(s),d=o.element.childNodes;d[r]&&o.element.removeChild(d[r]),d.length?o.element.insertBefore(c,d[r]):o.element.appendChild(c)}}}(e,t)}},b=v({render:function(){var e=this.$createElement;return(this._self._c||e)("div",{staticClass:"palette-panel"},[this._t("palette",[this._m(0)])],2)},staticRenderFns:[function(){var e=this.$createElement,t=this._self._c||e;return t("ul",{staticClass:"palette-group"},[t("li",[t("div",{staticClass:"palette-default-item type-a",attrs:{"data-type":"type-a"}},[this._v("A")])]),t("li",[t("div",{staticClass:"palette-default-item type-b",attrs:{"data-type":"type-b"}},[this._v("B")])]),t("li",[t("div",{staticClass:"palette-default-item type-c",attrs:{"data-type":"type-c"}},[this._v("C")])]),t("li",[t("div",{staticClass:"palette-default-item type-d",attrs:{"data-type":"type-d"}},[this._v("D")])])])}]},(function(e){e&&e("data-v-6c6ee110_0",{source:".palette-group{margin:0;padding:0;background:#fcfcfc;text-align:center;list-style:none}.palette-group>li{padding:14px 0}.palette-default-item{display:inline-block;width:40px;height:40px;line-height:40px;font-size:12px;color:#888;border:1px solid #999;border-radius:2px;cursor:pointer;user-select:none}.palette-default-item:hover{box-shadow:0 0 8px rgba(50,50,50,.3)}.type-a{border-radius:50%}.type-b{border-radius:50%;border:4px solid #333}.type-c,.type-d{height:30px;line-height:30px;border:1px solid #999}.type-d{position:relative}.type-d:after{content:'';position:absolute;top:0;right:0;width:5px;height:5px;border-radius:50%;background:#ccc}",map:void 0,media:void 0})}),{name:"PalettePanel",props:["selector"],data:function(){return{}},mounted:function(){this.$emit("registerPaletteEvent")}},void 0,!1,void 0,w,void 0),k=v({render:function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"tool-panel"},e._l(e.tools,(function(t,o){return n("div",{key:o,class:["tool-item",t.cls,{actived:"frameSelect"===t.type&&e.isFrameSelecting}],attrs:{title:t.title},on:{click:function(n){return e.onToolClick(t)}}},[e._v("\n        "+e._s(t.name)+"\n    ")])})),0)},staticRenderFns:[]},(function(e){e&&e("data-v-20cba315_0",{source:".tool-item{display:inline-block;margin-right:10px;user-select:none;cursor:pointer}.tool-item:last-child{margin-right:0}.tool-item.actived{color:#3a84ff}",map:void 0,media:void 0})}),{name:"ToolPanel",props:["tools","isFrameSelecting"],data:function(){return{}},methods:{onToolClick:function(e){this.$emit("onToolClick",e)}}},void 0,!1,void 0,w,void 0),_=v({render:function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"bk-flow-location",on:{mousedown:function(t){e.moveFlag=!1},mousemove:function(t){e.moveFlag=!0},mouseup:function(t){return e.onNodeClick(e.node,t)}}},["type-a"===e.node.type?n("div",{staticClass:"type-a"},[e._v("start")]):"type-b"===e.node.type?n("div",{staticClass:"type-b"},[e._v("end")]):"type-c"===e.node.type?n("div",{staticClass:"type-c"},[e._v("taskNode")]):"type-d"===e.node.type?n("div",{staticClass:"type-d"},[e._v("subFlow")]):n("div",{staticClass:"node-default"})])},staticRenderFns:[]},(function(e){e&&e("data-v-2d0e3090_0",{source:".bk-flow-location .type-c,.bk-flow-location .type-d{width:120px;height:60px;line-height:60px;border:1px solid #ccc;text-align:center;cursor:pointer}.bk-flow-location .type-c:hover,.bk-flow-location .type-d:hover{border-color:#348aff}.bk-flow-location .type-d{position:relative}.bk-flow-location .type-d:after{content:'';position:absolute;top:0;right:0;width:10px;height:10px;border-radius:50%;background:#ccc}.bk-flow-location .type-a,.bk-flow-location .type-b{width:60px;height:60px;line-height:60px;border-radius:50%;border:1px solid #ccc;text-align:center}.bk-flow-location .type-b{border:4px solid #333}.bk-flow-location .node-default{width:120px;height:80px;line-height:80px;border:1px solid #ccc;border-radius:2px;text-align:center}.bk-flow-location .node-default.selected{border:1px solid #3a84ff}",map:void 0,media:void 0})}),{name:"NodeTemplate",props:{node:{type:Object,default:function(){return{}}}},data:function(){return{moveFlag:!1}},methods:{onNodeClick:function(e,t){this.moveFlag||console.log(e.x,e.y)}}},void 0,!1,void 0,w,void 0);function C(e){return"touches"in e?e.touches[0]:e}function S(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t="",n=0;n<7;n++)t+=Math.floor(65536*(1+Math.random())).toString(16).substring(1);return e+t}var x={showPalette:{type:Boolean,default:!0},showTool:{type:Boolean,default:!0},tools:{type:Array,default:function(){return[{type:"zoomIn",name:"放大",cls:"tool-item"},{type:"zoomOut",name:"缩小",cls:"tool-item"},{type:"resetPosition",name:"重置",cls:"tool-item"},{type:"frameSelect",name:"框选",cls:"tool-item"}]}},editable:{type:Boolean,default:!0},selector:{type:String,default:"palette-default-item"},quickConnect:{type:Boolean,default:!0},data:{type:Object,default:function(){return{nodes:[],lines:[]}}},nodeOptions:{type:Object,default:function(){return{grid:[5,5]}}},connectorOptions:{type:Object,default:function(){return{paintStyle:{fill:"transparent",stroke:"#a9adb6",strokeWidth:2},hoverPaintStyle:{fill:"transparent",stroke:"#3a84ff"}}}},endpointOptions:{type:Object,default:function(){return{endpoint:"Dot",connector:["Flowchart",{stub:[1,6],alwaysRespectStub:!0,gap:8,cornerRadius:2}],connectorOverlays:[["PlainArrow",{width:8,length:6,location:1,id:"arrow"}]],anchor:["Left","Right","Top","Bottom"],isSource:!0,isTarget:!0}}}},$={mousedown:"ontouchstart"in document.documentElement?"touchstart":"mousedown",mousemove:"ontouchmove"in document.documentElement?"touchmove":"mousemove",mouseup:"ontouchend"in document.documentElement?"touchend":"mouseup"},N=v({render:function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"jsflow"},[n("div",{staticClass:"canvas-area"},[e.showTool?n("div",{staticClass:"tool-panel-wrap"},[e._t("toolPanel",[n("tool-panel",{attrs:{tools:e.tools,"is-frame-selecting":e.isFrameSelecting},on:{onToolClick:e.onToolClick}})])],2):e._e(),e.showPalette?n("div",{ref:"palettePanel",staticClass:"palette-panel-wrap"},[e._t("palettePanel",[n("palette-panel",{attrs:{selector:e.selector}})])],2):e._e(),n("div",{ref:"canvasFlowWrap",staticClass:"canvas-flow-wrap",style:e.canvasWrapStyle,on:e._d({},[e.mousedown,e.onCanvasMouseDown,e.mouseup,e.onCanvasMouseUp])},[n("div",{ref:"canvasFlow",staticClass:"canvas-flow",style:e.canvasStyle,attrs:{id:"canvas-flow"}},e._l(e.nodes,(function(t){return n("div",{key:t.id,staticClass:"jsflow-node canvas-node",attrs:{id:t.id},on:{mouseover:function(n){return e.toggleHighLight(t,!0)},mouseout:function(n){return e.toggleHighLight(t,!1)}}},[e._t("nodeTemplate",[n("node-template",{attrs:{node:t}})],{node:t})],2)})),0),e.isFrameSelecting?n("div",{staticClass:"canvas-frame-selector",style:e.frameSelectorStyle}):e._e()]),e.showAddingNode?n("div",{staticClass:"jsflow-node adding-node",style:e.setNodeInitialPos(e.addingNodeConfig)},[e._t("nodeTemplate",[n("node-template",{attrs:{node:e.addingNodeConfig}})],{node:e.addingNodeConfig})],2):e._e()])])},staticRenderFns:[]},(function(e){e&&e("data-v-e853be96_0",{source:".jsflow{height:100%;border:1px solid #ccc}.jsflow .canvas-area{position:relative;height:100%}.jsflow .tool-panel-wrap{position:absolute;top:20px;left:70px;padding:10px 20px;background:#c4c6cc;opacity:.65;border-radius:4px;z-index:4}.jsflow .palette-panel-wrap{float:left;width:60px;height:100%;border-right:1px solid #ccc}.jsflow .canvas-flow-wrap{position:relative;height:100%;overflow:hidden}.jsflow .canvas-flow{position:relative;min-width:100%;min-height:100%}.jsflow .canvas-frame-selector{position:absolute;border:1px solid #3a84ff;background:rgba(58,132,255,.15)}.jsflow .jsflow-node{position:absolute;z-index:1}.jsflow .jtk-endpoint{z-index:1}.jsflow .adding-node{opacity:.8}.jsflow .jtk-endpoint.jtk-dragging{z-index:0}",map:void 0,media:void 0})}),{name:"JsFlow",components:{PalettePanel:b,ToolPanel:k,NodeTemplate:_},model:{prop:"data",event:"change"},props:x,data:function(){var e=this.data;return p({nodes:e.nodes,lines:e.lines,canvasGrabbing:!1,isFrameSelecting:!1,mouseDownPos:{},canvasPos:{x:0,y:0},canvasOffset:{x:0,y:0},frameSelectorPos:{x:0,y:0},frameSelectorRect:{width:0,height:0},selectedNodes:[],showAddingNode:!1,addingNodeConfig:{},addingNodeRect:{},canvasRect:{},paletteRect:{},zoom:1},$)},computed:{canvasWrapStyle:function(){return{cursor:this.isFrameSelecting?"crosshair":this.canvasGrabbing?"-webkit-grabbing":"-webkit-grab"}},canvasStyle:function(){return{left:"".concat(this.canvasOffset.x,"px"),top:"".concat(this.canvasOffset.y,"px")}},frameSelectorStyle:function(){return{left:"".concat(this.frameSelectorPos.x,"px"),top:"".concat(this.frameSelectorPos.y,"px"),width:"".concat(this.frameSelectorRect.width,"px"),height:"".concat(this.frameSelectorRect.height,"px")}}},watch:{data:{handler:function(e){var t=e.nodes,n=e.lines;this.nodes=t,this.lines=n},deep:!0},editable:function(e){var t=this.$el.querySelectorAll(".canvas-node");this.toggleNodeDraggable(t,e)}},mounted:function(){this.initCanvas(),this.registerEvent(),this.renderData(),this.canvasRect=this.$refs.canvasFlow.getBoundingClientRect(),this.$refs.palettePanel&&(this.paletteRect=this.$refs.palettePanel.getBoundingClientRect(),this.registerPaletteEvent())},beforeDestroy:function(){this.$refs.palettePanel&&this.$refs.palettePanel.removeEventListener(this.mousedown,this.nodeCreateHandler),this.$el.removeEventListener(this.mousemove,this.nodeMovingHandler),document.removeEventListener(this.mouseup,this.nodeMoveEndHandler)},methods:{initCanvas:function(){var e={},t=p({},this.endpointOptions,this.connectorOptions);for(var n in t){var o=n[0].toUpperCase();e["".concat(o).concat(n.slice(1))]=t[n]}this.instance=u.jsPlumb.getInstance(p({container:"canvas-flow"},e))},registerEvent:function(){var e=this;this.instance.bind("beforeDrag",(function(t){return!!e.editable&&("function"!=typeof e.$listeners.onBeforeDrag||e.$listeners.onBeforeDrag(t))})),this.instance.bind("beforeDrop",(function(t){return!!e.editable&&("function"!=typeof e.$listeners.onBeforeDrop||e.$listeners.onBeforeDrop(t))})),this.instance.bind("connectionDrag",(function(t){"function"==typeof e.$listeners.connectionDrag&&e.$emit("connectionDrag",t)})),this.instance.bind("connection",(function(t){if("function"==typeof e.$listeners.onConnection)return e.$listeners.onConnection(t)})),this.instance.bind("connectionDragStop",(function(t,n){if(!t.target||!t.target.classList.contains("jsflow-node")){var o=e.getNodeWithEndpoint(n.target);if(o){var i=e.nodes.find((function(e){return o.id===e.id}));if("function"==typeof e.$listeners.onConnectionDragStop){var a={id:t.source.id,arrow:t.endpoints[0].anchor.type};e.$emit("onConnectionDragStop",a,i.id,n)}}}})),this.instance.bind("beforeDetach",(function(t){return"function"!=typeof e.$listeners.onBeforeDetach||e.$listeners.onBeforeDetach(t)})),this.instance.bind("connectionDetached",(function(t,n){var o=e.lines.filter((function(e){return e.source.id!==t.sourceId&&e.target.id!==t.targetId}));e.lines=o,"function"==typeof e.$listeners.onConnectionDetached&&e.$emit("onConnectionDetached",o)})),this.instance.bind("connectionMoved",(function(t,n){"function"==typeof e.$listeners.onConnectionMoved&&e.$emit("onConnectionMoved",lines)})),this.instance.bind("click",(function(t,n){"function"==typeof e.$listeners.onConnectionClick&&e.$emit("onConnectionClick",t,n)})),this.instance.bind("dblclick",(function(t,n){"function"==typeof e.$listeners.onConnectionDbClick&&e.$emit("onConnectionDbClick",t,n)}))},renderData:function(){var e=this;this.instance.batch((function(){e.nodes.forEach((function(t){e.initNode(t)})),e.lines.forEach((function(t){e.createConnector(t,e.connectorOptions)}))}))},createNode:function(e){var t=this;("function"!=typeof this.$listeners.onCreateNodeBefore||this.$listeners.onCreateNodeBefore(e))&&(this.nodes.push(e),this.$nextTick((function(){t.initNode(e)})))},initNode:function(e){var t=document.getElementById(e.id);t.style.left="".concat(e.x,"px"),t.style.top="".concat(e.y,"px"),this.setNodeDraggable(e,this.nodeOptions),this.setNodeEndPoint(e,this.endpointOptions),"function"==typeof this.$listeners.onCreateNodeAfter&&this.$emit("onCreateNodeAfter",e)},removeNode:function(e){var t=this.nodes.findIndex((function(t){return t.id===e.id}));this.nodes.splice(t,1),this.instance.remove(e.id)},setNodeEndPoint:function(e,t){var n=this;(e.endpoints||["Top","Right","Bottom","Left"]).forEach((function(o){n.instance.addEndpoint(e.id,p({anchor:o,uuid:o+e.id},t))}))},setNodeDraggable:function(e,t){if(this.editable){var n=this;this.instance.draggable(e.id,p({grid:[20,20],drag:function(t){var i=(0,o.default)({},e);n.$emit("onNodeMoving",i,t)},stop:function(t){var i=n.nodes.findIndex((function(t){return t.id===e.id})),a=(0,o.default)({},e),r=function(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=[],o=!0,i=!1,a=void 0;try{for(var r,c=(0,s.default)(e);!(o=(r=c.next()).done)&&(n.push(r.value),!t||n.length!==t);o=!0);}catch(e){i=!0,a=e}finally{try{o||null==c.return||c.return()}finally{if(i)throw a}}return n}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}(t.pos,2),c=r[0],d=r[1];a.x=c,a.y=d,n.nodes.splice(i,1,a),n.$emit("onNodeMoveStop",a,t)}},t))}},setNodePosition:function(e){var t=document.getElementById(e.id);t.style.left="".concat(e.x,"px"),t.style.top="".concat(e.y,"px"),this.instance.revalidate(t)},toggleNodeDraggable:function(e,t){this.instance.setDraggable(e,t)},setNodeInitialPos:function(e){return{left:"".concat(e.x,"px"),top:"".concat(e.y,"px")}},createConnector:function(e,t){var n=e.options||{};return this.instance.connect({source:e.source.id,target:e.target.id,uuids:[e.source.arrow+e.source.id,e.target.arrow+e.target.id]},p({},t,n))},getConnectorsByNodeId:function(e){return this.instance.getAllConnections().filter((function(t){return t.sourceId===e||t.targetId===e}))},getNodeWithEndpoint:function(e){var t=e.parentNode;return!(!t||"HTML"===t.nodeName)&&(t.classList.contains("jsflow-node")?t:this.getNodeWithEndpoint(t))},removeConnector:function(e){var t=this;this.instance.getConnections({source:e.source.id,target:e.target.id}).forEach((function(e){t.instance.deleteConnection(e)}))},addLineOverlay:function(e,t){var n=this;this.instance.getConnections({source:e.source.id,target:e.target.id}).forEach((function(e){e.addOverlay([t.type,{label:t.name,location:t.location,cssClass:t.cls,id:t.id,events:{click:function(e,t){n.$emit("onOverlayClick",e,t)}}}])}))},removeLineOverlay:function(e,t){this.instance.getConnections({source:e.source.id,target:e.target.id}).forEach((function(e){e.removeOverlay(t)}))},onCanvasMouseDown:function(e){e=C(e),this.isFrameSelecting?this.frameSelectHandler(e):(this.canvasGrabbing=!0,this.mouseDownPos={x:e.pageX,y:e.pageY},this.$refs.canvasFlowWrap.addEventListener(this.mousemove,this.canvasFlowMoveHandler,!1))},canvasFlowMoveHandler:function(e){e=C(e),this.canvasOffset={x:this.canvasPos.x+e.pageX-this.mouseDownPos.x,y:this.canvasPos.y+e.pageY-this.mouseDownPos.y}},onCanvasMouseUp:function(e){this.isFrameSelecting?this.frameSelectEndHandler(e):(this.canvasGrabbing=!1,this.$refs.canvasFlowWrap.removeEventListener(this.mousemove,this.canvasFlowMoveHandler),this.canvasPos={x:this.canvasOffset.x,y:this.canvasOffset.y})},registerPaletteEvent:function(){this.$refs.palettePanel.addEventListener(this.mousedown,this.nodeCreateHandler,!1)},nodeCreateHandler:function(e){var t=this,n=function e(t,n){return 1===t.nodeType&&t.classList.contains(n)?t:"HTML"!==t.parentNode.nodeName?e(t.parentNode,n):null}(e.target,this.selector);if(!n)return!1;var o=n.dataset.type?n.dataset.type:"",i=n.dataset?n.dataset.config:{};this.showAddingNode=!0,this.addingNodeConfig.id=S("node"),this.addingNodeConfig.type=o,this.$nextTick((function(){var n=t.$el.querySelector(".adding-node");t.addingNodeRect=n.getBoundingClientRect();var a=t.getAddingNodePos(e);t.addingNodeConfig=p({id:S("node"),type:o,x:a.x,y:a.y},i),t.$el.addEventListener(t.mousemove,t.nodeMovingHandler,!1),document.addEventListener(t.mouseup,t.nodeMoveEndHandler,!1)}))},nodeMovingHandler:function(e){var t=this.getAddingNodePos(e);this.$set(this.addingNodeConfig,"x",t.x),this.$set(this.addingNodeConfig,"y",t.y)},nodeMoveEndHandler:function(e){if(this.$el.removeEventListener(this.mousemove,this.nodeMovingHandler),document.removeEventListener(this.mouseup,this.nodeMoveEndHandler),this.showAddingNode=!1,e.pageX>this.paletteRect.left+this.paletteRect.width){var t=this.addingNodeConfig.x-this.paletteRect.width-this.canvasOffset.x,n=this.addingNodeConfig.y-this.canvasOffset.y;this.$set(this.addingNodeConfig,"x",t),this.$set(this.addingNodeConfig,"y",n),this.createNode(this.addingNodeConfig)}this.addingNodeConfig={},this.addingNodeRect={}},getAddingNodePos:function(e){return{x:e.pageX-this.paletteRect.left-this.addingNodeRect.width/2,y:e.pageY-this.paletteRect.top-this.addingNodeRect.height/2}},toggleHighLight:function(e){var t=this,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],o=(this.instance.getEndpoints(e.id),document.getElementById(e.id));this.instance.selectEndpoints({source:o}).each((function(e){var o=n?t.endpointOptions.hoverPaintStyle:t.endpointOptions.paintStyle;e.setStyle(o)}))},onToolClick:function(e){"function"==typeof this[e.type]&&this[e.type](),this.$emit("onToolClick",e)},setZoom:function(e){this.instance.setContainer("canvas-flow"),this.$refs.canvasFlow.style.transform="matrix("+e+",0,0,"+e+",0,0)",this.$refs.canvasFlow.style.transformOrigin="0 0",this.$refs.canvasFlow.zoom=e,this.zoom=e,this.instance.setZoom(e)},zoomIn:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1.1;this.setZoom(this.zoom*e)},zoomOut:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.9;this.setZoom(this.zoom*e)},resetPosition:function(){this.setZoom(1),this.setCanvasPosition(0,0)},setCanvasPosition:function(e,t){this.canvasOffset={x:e,y:t},this.canvasPos={x:e,y:t}},frameSelect:function(){this.isFrameSelecting=!0},frameSelectHandler:function(e){this.mouseDownPos={x:e.pageX-this.canvasRect.left,y:e.pageY-this.canvasRect.top},this.$refs.canvasFlowWrap.addEventListener(this.mousemove,this.frameSelectMovingHandler,!1)},frameSelectMovingHandler:function(e){var t=e.pageX-this.mouseDownPos.x-this.canvasRect.left,n=e.pageY-this.mouseDownPos.y-this.canvasRect.top;this.frameSelectorRect={width:Math.abs(t),height:Math.abs(n)},this.frameSelectorPos={x:t>0?this.mouseDownPos.x:this.mouseDownPos.x+t,y:n>0?this.mouseDownPos.y:this.mouseDownPos.y+n}},frameSelectEndHandler:function(e){this.$refs.canvasFlowWrap.removeEventListener(this.mousemove,this.frameSelectMovingHandler),this.$refs.canvasFlowWrap.removeEventListener(this.mouseup,this.frameSelectEndHandler),document.addEventListener("keydown",this.nodeLineCopyhandler,!1),document.addEventListener("keydown",this.nodeLinePastehandler,!1),document.addEventListener("keydown",this.nodeLineDeletehandler,!1),document.addEventListener(this.mousedown,this.cancelFrameSelectorHandler,{capture:!1,once:!0});var t=this.getSelectedNodes(),n=t.map((function(e){return e.id}));this.isFrameSelecting=!1,this.frameSelectorPos={x:0,y:0},this.frameSelectorRect={width:0,height:0},this.selectedNodes=t,this.clearNodesDragSelection(),this.addNodesToDragSelection(n),this.$emit("frameSelectNodes",t.slice(0))},getSelectedNodes:function(){var e=this,t=this.frameSelectorPos,n=t.x,o=t.y,i=this.frameSelectorRect,a=i.width,s=i.height;return this.nodes.filter((function(t){var i=document.querySelector("#".concat(t.id)),r=i.getBoundingClientRect(),c=r.left-e.canvasRect.left,d=r.top-e.canvasRect.top;if(n<c&&n+a>c&&o<d&&o+s>d)return i.classList.add("selected"),!0}))},cancelFrameSelectorHandler:function(e){this.selectedNodes.forEach((function(e){var t=document.querySelector("#".concat(e.id));t&&t.classList.remove("selected")})),this.selectedNodes=[],this.clearNodesDragSelection()},nodeLineCopyhandler:function(e){(e.ctrlKey||e.metaKey)&&67===e.keyCode&&this.$emit("onNodeCopy",this.selectedNodes)},nodeLinePastehandler:function(e){(e.ctrlKey||e.metaKey)&&86===e.keyCode&&this.$emit("onNodePaste")},nodeLineDeletehandler:function(e){var t=this;46!==e.keyCode&&8!==e.keyCode||(this.selectedNodes.forEach((function(e){t.removeNode(e)})),this.cancelFrameSelectorHandler())},addNodesToDragSelection:function(e){this.instance.addToDragSelection(e)},clearNodesDragSelection:function(){this.instance.clearDragSelection()}}},void 0,!1,void 0,w,void 0);"undefined"!=typeof window&&"Vue"in window&&window.Vue.component("js-flow",N),t.default=N},"11lW":function(e,t,n){"use strict";n.r(t);var o=n("Lpx6"),i=n("mEMe");for(var a in i)["default"].indexOf(a)<0&&function(e){n.d(t,e,(function(){return i[e]}))}(a);n("/lN2");var s=n("KHd+"),r=Object(s.a)(i.default,o.a,o.b,!1,null,"84dedc1a",null);r.options.__file="src/views/processManagement/processDesign/jsflowCanvas/NodeTemplate.vue",t.default=r.exports},"5otY":function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=c(n("14Xm")),i=c(n("D3Ub")),a=c(n("0nTK")),s=c(n("11lW")),r=n("CeR/");function c(e){return e&&e.__esModule?e:{default:e}}var d={endpoint:"Dot",connector:["Flowchart",{stub:[10,16],alwaysRespectStub:!0,gap:2,cornerRadius:10}],connectorOverlays:[["PlainArrow",{width:8,length:6,location:1,id:"arrow"}]],paintStyle:{fill:"rgba(0, 0, 0, 0)",stroke:"",strokeWidth:1,radius:8},hoverPaintStyle:{fill:"#EE8F62",stroke:"#EE8F62",radius:8},cssClass:"template-canvas-endpoint",hoverClass:"template-canvas-endpoint-hover",isSource:!1,isTarget:!1,maxConnections:-1},l={grid:[5,5],stop:!0},u={paintStyle:{fill:"transparent",stroke:"#a9adb6",strokeWidth:1},hoverPaintStyle:{fill:"transparent",stroke:"#3a84ff",strokeWidth:2},cssClass:"bk-sops-connector",hoverClass:"bk-sops-connector-hover",detachable:!1};t.default={name:"SecondFlow",components:{JsFlow:a.default,NodeTemplate:s.default},props:{addList:{type:Array,default:function(){return[]}},lineList:{type:Array,default:function(){return[]}},serviceAgreementList:{type:Array,default:function(){return[]}},flowInfo:{type:Object,default:function(){return{}}}},data:function(){return{hoverSlaObj:{},clickSecond:!1,isReset:!0,endpointOptions:d,connectorOptions:u,nodeOptions:l,canvasData:{nodes:[],lines:[]},toolsInfo:[[{type:"zoomIn",name:" ",title:this.$t("m.treeinfo['放大']"),cls:"bk-itsm-icon icon-flow-other-add"},{type:"zoomOut",name:" ",title:this.$t("m.treeinfo['缩小']"),cls:"bk-itsm-icon icon-flow-other-reduc"},{type:"fullPagePosition",name:" ",title:this.$t("m.treeinfo['全屏']"),cls:"bk-itsm-icon icon-flow-restore"},{type:"frameSelect",name:" ",title:this.$t("m.treeinfo['框选']"),cls:"bk-itsm-icon icon-choose-node"}],[{type:"zoomIn",name:" ",title:this.$t("m.treeinfo['放大']"),cls:"bk-itsm-icon icon-flow-other-add"},{type:"zoomOut",name:" ",title:this.$t("m.treeinfo['缩小']"),cls:"bk-itsm-icon icon-flow-other-reduc"},{type:"frameSelect",name:" ",title:this.$t("m.treeinfo['框选']"),cls:"bk-itsm-icon icon-choose-node"}]],nodeInfo:{},toolLimit:4,deleteInfo:{isShow:!1,title:this.$t('m.treeinfo["确认删除"]'),content:this.$t('m.treeinfo["确认后，此节点将从该流程中移除！"]'),info:{}},drawStatus:!1,isFullPage:!1,currentNode:{},instance:[]}},computed:{nodeStatus:function(){return this.$store.state.deployCommon.nodeStatus},stateNodeInfo:function(){return this.$store.state.deployCommon.nodeInfo}},created:function(){this.initDate()},mounted:function(){this.addLineOverlay(),this.instance=this.$refs.jsFlow.instance,this.$refs.jsFlow.zoomOut(this.flowInfo.narrowSize)},methods:{initDate:function(){var e=this;this.addList.forEach((function(t,n){var o=t.axis.x?t.axis.x:165+250*n,i=t.axis.y?t.axis.y:195+(n%2==1?5:0);e.canvasData.nodes.push({id:"node_"+t.id,x:o,y:i,type:t.type,name:t.name,showMore:!1,nodeInfo:t,options:{paintStyle:{fill:"rgba(0, 0, 0, 0)",stroke:"rgba(52, 138, 243, 0.15)",strokeWidth:1,radius:7}}}),e.$set(e.nodeInfo,"node_"+t.id,t)})),this.getLineData()},getLineData:function(){var e=this;this.lineList.forEach((function(t,n){e.canvasData.lines.push({source:{arrow:t.axis.start||"Right",id:"node_"+t.from_state},target:{arrow:t.axis.end||"Left",id:"node_"+t.to_state},lineInfo:t,options:{paintStyle:{fill:"transparent",stroke:e.getLineColor(t.id),strokeWidth:"#a9adb6"===e.getLineColor(t.id)?1:2}}})}))},updateCanvas:function(){this.removeAllConnector(),this.getLineData(),this.renderLineData()},slaIconClick:function(e){this.$emit("slaIconClick",e)},renderLineData:function(){var e=this;this.instance.batch((function(){e.canvasData.lines.forEach((function(t){e.$refs.jsFlow.createConnector(t)}))})),this.addLineOverlay()},removeAllConnector:function(){this.instance.deleteEveryConnection(),this.canvasData.lines=[]},getLineColor:function(e){return"color"in this.hoverSlaObj&&"lines"in this.hoverSlaObj?-1!==this.hoverSlaObj.lines.indexOf(e)?this.hoverSlaObj.color:"rgba(176, 180, 189, 0.3)":"#a9adb6"},getLabelColor:function(e){return"color"in this.hoverSlaObj&&"lines"in this.hoverSlaObj?-1!==this.hoverSlaObj.lines.indexOf(e)?"#a9adb6":"rgba(176, 180, 189, 0.3)":"#a9adb6"},isHoverNode:function(e){return"color"in this.hoverSlaObj&&"lines"in this.hoverSlaObj&&-1===this.hoverSlaObj.states.indexOf(e)},errorNodes:function(e){var t=this;this.canvasData.nodes.forEach((function(n){e.forEach((function(e){n.nodeInfo.id===e&&t.$set(n.nodeInfo,"errorInfo",!0)}))}))},addLineOverlay:function(){var e=this;this.canvasData.lines.forEach((function(t){var n={source:t.source,target:t.target,lineInfo:t.lineInfo,id:t.lineInfo.id,name:t.lineInfo.name};e.lineOverlay(n)}))},lineOverlay:function(e){if(!this.canvasData.nodes.some((function(t){return e.source.id===t.id&&"START"===t.type}))){var t=this.getLabelColor(e.id),n='<span class="bk-label-test-name" style="color: '+t+"; border-color: "+t+'">'+(e.name||this.$t('m.treeinfo["默认"]'))+"</span>",o={id:"label_"+e.id,type:"Label",name:n,cls:"label-test",location:.5};this.$refs.jsFlow.addLineOverlay(e,o)}},removerLine:function(e){this.$refs.jsFlow.removeConnector({source:{id:e.sourceId},target:{id:e.targetId}})},onToolClick:function(e){"fullPagePosition"===e.type&&(this.isFullPage=!0)},onResetPosition:function(){this.$refs.jsFlow.resetPosition()},onConnectionClick:function(e,t){},onConnection:function(e){this.drawStatus&&(this.drawLine(e),this.drawStatus=!1)},onConnectionDragStop:function(e,t,n){var o={sourceId:e.id,targetId:t};if(this.checkLineInfo(o)){var i=void 0,a={source:e,target:{id:t}},s=document.getElementById(t).getBoundingClientRect(),r=n.clientX-s.left,c=n.clientY-s.Top;i=r<s.width/2?c<s.height/2?r>c?"Top":"Left":r>s.height-c?"Bottom":"Left":c<s.height/2?s.width-r>c?"Top":"Right":s.width-r>s.height-c?"Bottom":"Right",a.target.arrow=i,this.$refs.jsFlow.createConnector(a);var d={sourceId:e.id,targetId:t,sourceEndpoint:{anchor:{type:e.arrow}},targetEndpoint:{anchor:{type:i}}};this.drawLine(d),this.drawStatus=!1}},onBeforeDrop:function(e){return this.checkLineInfo(e)},checkLineInfo:function(e){var t=this.canvasData.nodes.filter((function(t){return t.id===e.sourceId})),n=this.canvasData.nodes.filter((function(t){return t.id===e.targetId})),o={status:!0,msg:""};"START"===t[0].type&&(this.canvasData.lines.some((function(e){return e.source.id===t[0].id}))&&(o.status=!1,o.msg=this.$t('m.treeinfo["开始节点只能单一输出！"]')));"START"===n[0].type&&(o.status=!1,o.msg=this.$t('m.treeinfo["开始节点只能输出！"]')),"END"===t[0].type&&(o.status=!1,o.msg=this.$t('m.treeinfo["结束节点只能输入！"]')),"START"===t[0].type&&"END"===n[0].type&&(o.status=!1,o.msg=this.$t('m.treeinfo["开始节点和结束节点不能直接相连！"]')),e.sourceId===e.targetId&&(o.status=!1,o.msg=this.$t('m.treeinfo["自身不能相连！"]'));for(var i=0;i<this.canvasData.lines.length;i++)e.sourceId===this.canvasData.lines[i].source.id&&e.targetId===this.canvasData.lines[i].target.id&&(o.status=!1,o.msg=this.$t('m.treeinfo["已存在的连线！"]'));return o.status||this.$bkMessage({message:o.msg,theme:"warning"}),this.drawStatus=!0,o.status},drawLine:function(e){var t=this;return(0,i.default)(o.default.mark((function n(){var i,a,s,c;return o.default.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(i="",a="",s={targetId:"",sourceId:""},t.canvasData.nodes.forEach((function(t,n){t.id===e.sourceId&&(a=t.nodeInfo.id,s.sourceId=t.id),t.id===e.targetId&&(i=t.nodeInfo.id,s.targetId=t.id)})),c={workflow:t.addList[0].workflow,name:t.$t('m.treeinfo["默认"]'),axis:{start:e.sourceEndpoint.anchor.type,end:e.targetEndpoint.anchor.type},from_state:a,to_state:i},!t.canvasData.lines.some((function(e){return e.source.id===s.sourceId&&e.target.id===s.targetId}))){n.next=8;break}return n.abrupt("return");case 8:if(!t.clickSecond){n.next=10;break}return n.abrupt("return");case 10:return t.clickSecond=!0,n.next=13,t.$store.dispatch("deployCommon/createLine",{lineParams:c}).then((function(n){var o=[{source:{arrow:c.axis.start,id:e.sourceId},target:{arrow:c.axis.end,id:e.targetId},lineInfo:n.data,id:n.data.id,name:n.data.name}];t.updateLine(o,"add"),t.lineOverlay(o[0])})).catch((function(e){(0,r.errorHandler)(e,t),t.canvasData.lines.some((function(e){return e.source.id===s.sourceId&&e.target.id===s.targetId}))||t.$refs.jsFlow.removeConnector({source:{id:s.sourceId},target:{id:s.targetId}})})).finally((function(){t.clickSecond=!1}));case 13:case"end":return n.stop()}}),n,t)})))()},updateLine:function(e,t){var n=this;"delete"===t?e.forEach((function(e){n.canvasData.lines.forEach((function(t,o){t.source.id===e.source.id&&t.target.id===e.target.id&&n.canvasData.lines.splice(o,1)}))})):"update"===t?e.forEach((function(e){n.canvasData.lines.forEach((function(t,n){t.source.id===e.source.id&&t.target.id===e.target.id&&(t.lineInfo=e.lineInfo)}))})):"add"===t&&(this.canvasData.lines=this.canvasData.lines.concat(e))},onConnectionDetached:function(){},onZoomIn:function(){this.toolLimit>9||(this.toolLimit+=1,this.$refs.jsFlow&&this.$refs.jsFlow.zoomIn())},onZoomOut:function(){0!==this.toolLimit&&(this.toolLimit-=1,this.$refs.jsFlow&&this.$refs.jsFlow.zoomOut())},onCanvasFrameSelect:function(){},handleScroll:function(e){e.deltaY>0?this.onZoomOut():this.onZoomIn()},updateNode:function(e){var t=this;this.$refs.jsFlow.createNode(e.node);var n=[];this.canvasData.nodes.forEach((function(o){var i=o.x-e.node.x,a=o.y-e.node.y;if(e.node.id!==o.id&&a>=-40&&i>=-150&&i<=150){var s={id:o.id,nodeInfo:o.nodeInfo,x:o.x,y:o.y+100};n.push(s),setTimeout((function(){t.$refs.jsFlow.setNodePosition(s),t.moveNode(s)}),100)}})),this.canvasData.nodes.forEach((function(e){n.forEach((function(t){e.id===t.id&&(e.x=t.x,e.y=t.y)}))}))},deleteNode:function(){var e=this,t=this.deleteInfo.info.nodeInfo.id;this.clickSecond||(this.clickSecond=!0,this.$store.dispatch("deployCommon/deleteNode",t).then((function(t){e.deleteInfo.info.nodeInfo.is_draft||e.$bkMessage({message:e.$t('m.treeinfo["删除成功"]'),theme:"success"});for(var n=e.$refs.jsFlow.getConnectorsByNodeId(e.deleteInfo.info.id),o=[],i=0;i<n.length;i++)o.push({source:{arrow:"Left",id:n[i].sourceId},target:{arrow:"Left",id:n[i].targetId},lineInfo:{}});o.length&&e.updateLine(o,"delete"),e.$refs.jsFlow.removeNode(e.deleteInfo.info),e.closeDelete()})).catch((function(t){e.$bkMessage({message:t.data.msg,theme:"error"})})).finally((function(){e.clickSecond=!1})))},closeDelete:function(){this.deleteInfo.isShow=!1},configuNode:function(e){this.isReset=!1,this.$emit("configuNode",e),this.isReset=!0},onNodeMoveStop:function(e,t){if(e.x===this.currentNode.x&&e.y===this.currentNode.y)return this.canvasData.nodes.forEach((function(e){e.showMore=!1})),void this.canvasData.nodes.forEach((function(t){e.id===t.id&&(t.showMore=!0)}));for(var n=!1,o=0;o<this.canvasData.nodes.length;o++){var i=this.canvasData.nodes[o];if(e.id!==i.id){var a={x:i.x-e.x,y:i.y-e.y};if("NORMAL"===e.type||"ROUTER"===e.type||"TASK"===e.type){if("NORMAL"===i.type||"ROUTER"===i.type||"TASK"===i.type){if(a.x>=-150&&a.x<=150&&a.y>=-40&&a.y<=40){n=!0;break}}else if(a.x>=-40&&a.x<=150&&a.y>=-40&&a.y<=40){n=!0;break}}else if("NORMAL"===i.type||"ROUTER"===i.type||"TASK"===i.type){if(a.x>=-150&&a.x<=40&&a.y>=-40&&a.y<=40){n=!0;break}}else if(a.x>=-40&&a.x<=40&&a.y>=-40&&a.y<=40){n=!0;break}}}if(n){var s={id:e.id,x:this.stateNodeInfo.x,y:this.stateNodeInfo.y};this.$refs.jsFlow.setNodePosition(s);for(var r=0;r<this.canvasData.nodes.length;r++)e.id===this.canvasData.nodes[r].id&&(this.canvasData.nodes[r].x=this.stateNodeInfo.x,this.canvasData.nodes[r].y=this.stateNodeInfo.y)}else this.moveNode(e)},onNodeMoving:function(e,t){var n=e;n.x=t.pos[0],n.y=t.pos[1]},getBestArrow:function(e,t){var n=this,o={parent:[],parentLine:[],children:[],childrenLine:[]},i=[];this.canvasData.lines.forEach((function(e){var t=!1;n.canvasData.lines.forEach((function(n){e.source.id===n.target.id&&e.target.id===n.source.id&&(t=!0)})),t||i.push(e)})),i.forEach((function(t){e.id===t.target.id&&(o.parent.push(t.source.id),o.parentLine.push(t)),e.id===t.source.id&&(o.children.push(t.target.id),o.childrenLine.push(t))}));var a=["NORMAL","ROUTER","TASK","TASK-SOPS"],s=this.getEndPointInfo(e,a),r={},c={};o.parent.forEach((function(e){n.canvasData.nodes.forEach((function(t){e===t.id&&(r[e]=n.getEndPointInfo(t,a))}))})),o.children.forEach((function(e){n.canvasData.nodes.forEach((function(t){e===t.id&&(c[e]=n.getEndPointInfo(t,a))}))}));var d=[];o.parent.forEach((function(t){d=[],s.forEach((function(e){var n;r[t].forEach((function(t){d.push({cArrow:e.anchor,pArrow:t.anchor,distance:Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2)})})),d=d.sort((n="distance",function(e,t){return e[n]-t[n]}))}));var o=d[0],i={source:{id:t},target:{id:e.id}};n.deleteBestLine(i,o)}));var l=[];o.children.forEach((function(t){l=[],s.forEach((function(e){var n;c[t].forEach((function(t){l.push({cArrow:t.anchor,pArrow:e.anchor,distance:Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2)})})),l=l.sort((n="distance",function(e,t){return e[n]-t[n]}))}));var o=l[0],i={source:{id:e.id},target:{id:t}};n.deleteBestLine(i,o)}))},getEndPointInfo:function(e,t){return[{anchor:"Top",x:e.x+(t.some((function(t){return t===e.type}))?75:20),y:e.y},{anchor:"Left",x:e.x,y:e.y+20},{anchor:"Right",x:e.x+(t.some((function(t){return t===e.type}))?150:40),y:e.y+20},{anchor:"Bottom",x:e.x+(t.some((function(t){return t===e.type}))?75:20),y:e.y+40}]},deleteBestLine:function(e,t){var n=this;this.canvasData.lines.some((function(n){return n.source.id===e.source.id&&n.target.id===e.target.id&&n.source.arrow===t.pArrow&&n.target.arrow===t.cArrow}))||(this.$refs.jsFlow.removeConnector({source:{id:e.source.id},target:{id:e.target.id}}),this.canvasData.lines.forEach((function(o){if(o.source.id===e.source.id&&o.target.id===e.target.id){o.source.arrow=t.pArrow,o.target.arrow=t.cArrow;var i={source:{arrow:t.pArrow,id:e.source.id},target:{arrow:t.cArrow,id:e.target.id},lineInfo:o.lineInfo};n.$refs.jsFlow.createConnector(i);var a={source:i.source,target:i.target,lineInfo:i.lineInfo,id:o.lineInfo.id,name:o.lineInfo.name};n.lineOverlay(a)}})))},moveNode:function(e){var t=this,n={axis:{x:e.x,y:e.y}},o=e.nodeInfo.id;this.$store.dispatch("deployCommon/updateNodeAxis",{params:n,id:o}).then((function(e){})).catch((function(e){t.$bkMessage({message:e.data.msg,theme:"error"})}))}}}},"8fuC":function(e,t,n){"use strict";n.r(t);var o=n("5otY"),i=n.n(o);for(var a in o)["default"].indexOf(a)<0&&function(e){n.d(t,e,(function(){return o[e]}))}(a);t.default=i.a},BEWh:function(e,t,n){"use strict";n.r(t);var o=n("FFUY"),i=n("8fuC");for(var a in i)["default"].indexOf(a)<0&&function(e){n.d(t,e,(function(){return i[e]}))}(a);n("eBxT"),n("eEte");var s=n("KHd+"),r=Object(s.a)(i.default,o.a,o.b,!1,null,"1a8a2b56",null);r.options.__file="src/views/service/sla/slaJsflowCanvas/secondFlow.vue",t.default=r.exports},FFUY:function(e,t,n){"use strict";n.d(t,"a",(function(){return o})),n.d(t,"b",(function(){return i}));var o=function(){var e=this,t=e.$createElement,n=e._self._c||t;return e.isReset?n("div",{class:{"bk-second-flow":!0,"bk-full-page":e.isFullPage}},[n("bk-button",{staticClass:"bk-close-btn",attrs:{text:!0,icon:"close"},on:{click:function(t){e.isFullPage=!1,e.onResetPosition()}}}),e._v(" "),n("p",{staticClass:"bk-sla-text"},[e._v(e._s(e.$t("m.serviceConfig['“S”代表协议生效节点，“E”代表协议结束节点，不支持节点间交叉添加协议']")))]),e._v(" "),n("js-flow",{ref:"jsFlow",attrs:{selector:"entry-item","endpoint-options":e.endpointOptions,"connector-options":e.connectorOptions,"node-options":e.nodeOptions,tools:e.toolsInfo[+e.isFullPage],editable:!1},on:{onToolClick:e.onToolClick,onConnectionClick:e.onConnectionClick,onConnection:e.onConnection,onConnectionDragStop:e.onConnectionDragStop,onBeforeDrop:e.onBeforeDrop,onNodeMoveStop:e.onNodeMoveStop,onNodeMoving:e.onNodeMoving},scopedSlots:e._u([{key:"nodeTemplate",fn:function(t){var o=t.node;return[n("div",{staticClass:"bk-sla-rect"},e._l(e.serviceAgreementList,(function(t,i){return n("span",{key:i},[t.start_node_id===o.nodeInfo.id?n("span",{staticClass:"bk-sla-se",style:"background: "+t.color,on:{click:function(n){return e.slaIconClick(t)},mouseenter:function(n){e.hoverSlaObj=t,e.updateCanvas()},mouseout:function(t){e.hoverSlaObj={},e.updateCanvas()}}},[e._v("S")]):e._e(),e._v(" "),t.end_node_id===o.nodeInfo.id?n("span",{staticClass:"bk-sla-se",style:"background: "+t.color,on:{click:function(n){return e.slaIconClick(t)},mouseenter:function(n){e.hoverSlaObj=t,e.updateCanvas()},mouseout:function(t){e.hoverSlaObj={},e.updateCanvas()}}},[e._v("E")]):e._e()])})),0),e._v(" "),n("node-template",{ref:"templateNode",class:{"bk-sla-hover-node-shadow":e.isHoverNode(o.nodeInfo.id)},attrs:{node:o,"canvas-data":e.canvasData},on:{configuNode:e.configuNode}})]}}],null,!1,3834796666),model:{value:e.canvasData,callback:function(t){e.canvasData=t},expression:"canvasData"}})],1):e._e()},i=[];o._withStripped=!0},Lpx6:function(e,t,n){"use strict";n.d(t,"a",(function(){return o})),n.d(t,"b",(function(){return i}));var o=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{directives:[{name:"bk-clickoutside",rawName:"v-bk-clickoutside",value:e.closeNode,expression:"closeNode"}],staticClass:"bk-flow-location",class:{"bk-error-flow":e.node.nodeInfo&&e.node.nodeInfo.errorInfo},on:{mousedown:function(t){return e.moveDoneFn(e.node)},mousemove:e.moveFn,mouseup:function(t){return e.onNodeClick(e.node,t)},contextmenu:function(t){return t.preventDefault(),e.rightClickNode(e.node,t)},click:function(t){return e.clickNode(e.node,t)},mouseout:function(t){return e.hoverNode(e.node)}}},["START"===e.node.type?n("div",{staticClass:"startpoint",attrs:{"data-test-id":"start"}},[e._v("\n        "+e._s(e.$t("m.treeinfo['开始']"))+"\n    ")]):e._e(),e._v(" "),"END"===e.node.type?n("div",{staticClass:"endpoint"},[e._v("\n        "+e._s(e.$t('m.treeinfo["结束"]'))+"\n    ")]):e._e(),e._v(" "),e._l(e.typeList,(function(t,o){return[e.node.type===t.type?[n("div",{key:o,staticClass:"common-node"},[n("span",{staticClass:"common-auto-icon",class:{"bk-is-draft":e.node.nodeInfo&&e.node.nodeInfo.is_draft},on:{click:function(t){return t.stopPropagation(),e.openconfigu.apply(null,arguments)}}},["TASK"!==t.type?n("i",{staticClass:"bk-itsm-icon",class:t.iconStyle}):n("span",{staticStyle:{"font-size":"11px","font-weight":"bold"}},[e._v("API")])]),e._v(" "),n("span",{staticClass:"bk-more-word",attrs:{title:e.node.name||e.$t("m.treeinfo['新增节点']")}},[e._v(e._s(e.node.name||e.$t("m.treeinfo['新增节点']")))]),e._v(" "),e.node.nodeInfo&&e.node.nodeInfo.is_builtin?e._e():n("span",{staticClass:"bk-node-delete",on:{click:function(t){return t.stopPropagation(),e.clickDelete(e.node)},mouseup:function(e){e.stopPropagation()},mousedown:function(e){e.stopPropagation()}}},[e._v("×")]),e._v(" "),!e.toolStatus&&e.node.nodeInfo&&e.node.nodeInfo.is_builtin?n("div",{staticClass:"bk-toop-info"},[n("p",[n("span",[e._v(e._s(e.$t("m.treeinfo['单击：']")))]),e._v(e._s(e.$t("m.treeinfo['快速配置节点']")))]),e._v(" "),n("p",[n("span",[e._v(e._s(e.$t("m.treeinfo['右键：']")))]),e._v(e._s(e.$t("m.treeinfo['调出快速添加节点菜单']")))]),e._v(" "),n("i",{staticClass:"bk-icon icon-close",on:{click:function(t){return t.stopPropagation(),e.closeTool.apply(null,arguments)}}}),e._v(" "),n("i",{staticClass:"bk-squrae"})]):e._e()])]:e._e()]})),e._v(" "),"ROUTER-P"===e.node.type?n("div",{staticClass:"common-branch"},[n("i",{staticClass:"bk-itsm-icon icon-flow-convergence"}),e._v(" "),n("span",{staticClass:"bk-node-delete",on:{click:function(t){return t.stopPropagation(),e.clickDelete(e.node)}}},[e._v("×")])]):e._e(),e._v(" "),"COVERAGE"===e.node.type?n("div",{staticClass:"common-branch"},[n("i",{staticClass:"bk-itsm-icon icon-flow-branch"}),e._v(" "),n("span",{staticClass:"bk-node-delete",on:{click:function(t){return t.stopPropagation(),e.clickDelete(e.node)}}},[e._v("×")])]):e._e(),e._v(" "),n("div",{directives:[{name:"show",rawName:"v-show",value:e.node.showMore&&"START"!==e.node.type&&"END"!==e.node.type,expression:"node.showMore && node.type !== 'START' && node.type !== 'END'"}],staticClass:"bk-flow-fast"},[n("div",{staticClass:"bk-engine-node"},[n("ul",e._l(e.clickList,(function(t,o){return n("li",{key:o,staticClass:"tool",attrs:{title:t.name},on:{click:function(n){return n.stopPropagation(),e.addNormal(e.node,t)}}},[n("i",{staticClass:"bk-itsm-icon",class:[t.iconStyle,{"bk-font-style":["icon-icon-artificial","icon-api-node","icon-task-icon","con-copy-new","icon-sign-node","icon-approval-node"].includes(t.iconStyle)}]})])})),0)]),e._v(" "),n("div",{staticClass:"bk-engine-word"},[n("span",{staticClass:"bk-canvas-span bk-engine-configur",class:{"bk-engine-builtin":"ROUTER-P"===e.node.type||"COVERAGE"===e.node.type},on:{click:function(t){return t.stopPropagation(),e.openconfigu.apply(null,arguments)}}},[e._v(e._s(e.$t('m.treeinfo["配置"]')))]),e._v(" "),n("span",{staticClass:"bk-canvas-span bk-engine-delete",class:{"bk-engine-builtin":e.node.nodeInfo&&e.node.nodeInfo.is_builtin},on:{click:function(t){return t.stopPropagation(),e.clickDelete(e.node)}}},[e._v(e._s(e.$t('m.treeinfo["删除"]')))])])])],2)},i=[];o._withStripped=!0},MVkS:function(e,t,n){"use strict";n.r(t);var o=n("tnrg"),i=n("iX8w");for(var a in i)["default"].indexOf(a)<0&&function(e){n.d(t,e,(function(){return i[e]}))}(a);n("Qegc"),n("dI7d");var s=n("KHd+"),r=Object(s.a)(i.default,o.a,o.b,!1,null,"996df9b2",null);r.options.__file="src/views/service/sla/index.vue",t.default=r.exports},Qegc:function(e,t,n){"use strict";n("vU3E")},R1Rv:function(e,t,n){},V7oC:function(e,t,n){"use strict";t.__esModule=!0;var o,i=n("SEkw"),a=(o=i)&&o.__esModule?o:{default:o};t.default=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),(0,a.default)(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}()},Ybda:function(e,t,n){},dI7d:function(e,t,n){"use strict";n("Ybda")},eBxT:function(e,t,n){"use strict";n("sr4l")},eEte:function(e,t,n){"use strict";n("m2wS")},iCc5:function(e,t,n){"use strict";t.__esModule=!0,t.default=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}},iX8w:function(e,t,n){"use strict";n.r(t);var o=n("+aVv"),i=n.n(o);for(var a in o)["default"].indexOf(a)<0&&function(e){n.d(t,e,(function(){return o[e]}))}(a);t.default=i.a},m2wS:function(e,t,n){},mEMe:function(e,t,n){"use strict";n.r(t);var o=n("snvg"),i=n.n(o);for(var a in o)["default"].indexOf(a)<0&&function(e){n.d(t,e,(function(){return o[e]}))}(a);t.default=i.a},q7Rq:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ProcessTools=void 0;var o=a(n("iCc5")),i=a(n("V7oC"));function a(e){return e&&e.__esModule?e:{default:e}}t.ProcessTools=function(){function e(t,n){(0,o.default)(this,e),this.allNode=t,this.allLine=n,this.startNodeId=t.find((function(e){return"START"===e.type})).id,this.endNodeId=t.find((function(e){return"END"===e.type})).id,this.getAllPath()}return(0,i.default)(e,[{key:"getAllPath",value:function(){var e=this,t=[];return function n(o,i){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;a||(a=[]),o===i&&t.push(a.slice(0));for(var s=0;s<e.allLine.length;s++){var r=e.allLine[s];if(r.from_state===o){if(a.includes(r.to_state))continue;a.push(r.to_state),n(r.to_state,i,a),a.pop()}}}(e.startNodeId,e.endNodeId),e.allPath=t,t}},{key:"getAfterNodes",value:function(e){var t=[];return this.allPath.forEach((function(n){var o=n.indexOf(e);-1!==o&&n.slice(o+1).forEach((function(e){t.includes(e)||t.push(e)}))})),this.allNode.filter((function(e){return t.includes(e.id)&&""!==e.name&&"START"!==e.type&&"END"!==e.type}))}},{key:"getSlaAfterNodes",value:function(e){var t=this;return t.getAfterNodes(e).filter((function(n){return t.allPath.filter((function(t){return t.includes(e)||t.includes(n.id)})).every((function(t){return t.includes(e)&&t.includes(n.id)}))}))}}]),e}()},snvg:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=n("ygAv"),i=n("CeR/");t.default={name:"NodeTemplate",props:{node:{type:Object,default:function(){return{}}},canvasData:{type:Object,default:function(){return{}}}},data:function(){return{moveFlag:!1,clickSecond:!1,toolStatus:!1,valueInfo:{node:{},line:{}},typeList:[{type:"NORMAL",iconStyle:"icon-icon-person"},{type:"ROUTER",iconStyle:"icon-icon-person"},{type:"TASK",iconStyle:"icon-api-icon"},{type:"TASK-SOPS",iconStyle:"icon-task-node"},{type:"APPROVAL",iconStyle:"icon-approval-node"},{type:"SIGN",iconStyle:"icon-sign-node-white f18"}],clickList:[{type:"NORMAL",name:this.$t('m.treeinfo["手动节点"]'),iconStyle:"icon-icon-artificial"},{type:"TASK",name:this.$t('m.treeinfo["API节点"]'),iconStyle:"icon-api-node"},{type:"TASK-SOPS",name:this.$t('m.treeinfo["标准运维节点"]'),iconStyle:"icon-task-icon"},{type:"SIGN",name:this.$t("m.treeinfo['会签节点']"),iconStyle:"icon-sign-node"},{type:"APPROVAL",name:this.$t("m.treeinfo['审批节点']"),iconStyle:"icon-approval-node"},{type:"COVERAGE",name:this.$t('m.treeinfo["汇聚网关"]'),iconStyle:"icon-flow-branch"},{type:"ROUTER-P",name:this.$t('m.treeinfo["并行网关"]'),iconStyle:"icon-flow-convergence"},{type:"COPY",name:this.$t('m.treeinfo["复制节点"]'),iconStyle:"icon-copy-new"}],currentNode:{}}},mounted:function(){this.toolStatus=localStorage.getItem("toolStatus")||!1},methods:{hoverNode:function(e){e.nodeInfo&&e.nodeInfo.errorInfo&&(e.nodeInfo.errorInfo=!1)},moveDoneFn:function(e){this.moveFlag=!1;for(var t=document.getElementsByClassName("jsflow-node"),n=0;n<t.length;n++)t[n].style["z-index"]=101;document.getElementById(e.id)&&(document.getElementById(e.id).style["z-index"]=102)},moveFn:function(){this.moveFlag=!0},onNodeClick:function(e,t){this.currentNode=e;var n=Boolean(e.showMore);if(this.$set(e,"showMore",n),this.moveFlag){var o=this.canvasData.nodes.find((function(t){return t.id===e.id}));this.$store.commit("deployCommon/changeNodeInfo",o)}else;this.moveFlag=!1},clickNode:function(e,t){this.openconfigu()},rightClickNode:function(e,t){e&&(this.$emit("closeShow"),e.showMore=!0)},openconfigu:function(){var e=(0,o.deepClone)(this.node);Math.abs(e.x-this.currentNode.x)>3||Math.abs(e.y-this.currentNode.y)>3||"ROUTER-P"!==e.type&&"COVERAGE"!==e.type&&"START"!==e.type&&"END"!==e.type&&this.$emit("configuNode",e.nodeInfo)},closeNode:function(){this.node.showMore=!1},addNormal:function(e,t){var n=this;if(!this.clickSecond)if(this.clickSecond=!0,this.$store.commit("deployCommon/changeNodeStatus",!0),"COPY"!==t.type){var o=this.canvasData.lines.filter((function(t){return t.source.id===e.id})),a="NORMAL"===e.type||"TASK"===e.type?310:210,s={workflow:e.nodeInfo.workflow,name:"",type:t.type,is_terminable:!1,axis:{x:e.x+a,y:e.y+80*o.length},extras:{}};this.$store.dispatch("deployCommon/creatNode",{params:s}).then((function(i){n.valueInfo.node={id:"node_"+i.data.id,x:e.x+a,y:e.y+80*o.length,type:t.type,name:i.data.name,showMore:!1,nodeInfo:i.data},n.$emit("closeShow"),n.$emit("updateNode",n.valueInfo),n.addNewLine(e,i.data.id)})).catch((function(e){(0,i.errorHandler)(e,n)})).finally((function(){n.clickSecond=!1,n.$store.commit("deployCommon/changeNodeStatus",!1)}))}else{var r=this.node.nodeInfo.id;this.$store.dispatch("deployCommon/copyNode",r).then((function(e){n.valueInfo.node={id:"node_"+e.data.id,x:e.data.axis.x,y:e.data.axis.y,type:e.data.type,name:e.data.name,showMore:!1,nodeInfo:e.data},n.$emit("closeShow"),n.$emit("updateNode",n.valueInfo)})).catch((function(e){(0,i.errorHandler)(e,n)})).finally((function(){n.clickSecond=!1,n.$store.commit("deployCommon/changeNodeStatus",!1)}))}},addNewLine:function(e,t){var n=this,o={workflow:e.nodeInfo.workflow,name:this.$t('m.treeinfo["默认"]'),axis:{start:"Right",end:"Left"},from_state:e.nodeInfo.id,to_state:t};this.$store.dispatch("deployCommon/createLine",{lineParams:o}).then((function(t){n.valueInfo.line={source:{arrow:"Right",id:e.id},target:{arrow:"Left",id:n.valueInfo.node.id},lineInfo:t.data},n.$emit("fastAddNode",n.valueInfo),n.$emit("updateLine",n.valueInfo.line,"add")})).catch((function(e){(0,i.errorHandler)(e,n)}))},clickDelete:function(e){this.$emit("openDelete",e)},closeTool:function(){this.toolStatus=!0,localStorage.setItem("toolStatus",!0)}}}},sr4l:function(e,t,n){},tnrg:function(e,t,n){"use strict";n.d(t,"a",(function(){return o})),n.d(t,"b",(function(){return i}));var o=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"project-sla-agreement"},[n("div",{staticClass:"is-title"},[n("p",{staticClass:"bk-come-back",on:{click:e.goToServiceList}},[n("i",{staticClass:"bk-icon icon-arrows-left"}),e._v(" "),n("span",[e._v(e._s(e.serviceData.name||"--"))]),e._v(" > SLA"+e._s(e.$t("m['设置']"))+"\n        ")])]),e._v(" "),n("div",{staticClass:"sla-agreement-container"},[n("div",{directives:[{name:"bkloading",rawName:"v-bkloading",value:{isLoading:e.serviceLoading},expression:"{ isLoading: serviceLoading }"}],staticClass:"bk-content-group"},[n("bk-form",{ref:"dynamicForm",staticClass:"bk-sla-box",attrs:{"label-width":250,"form-type":"vertical"}},[n("div",{staticClass:"bk-sla-content"},[n("span",[e._v(e._s(e.$t("m.serviceConfig['是否启用']")))]),e._v(" "),n("bk-switcher",{attrs:{size:"small",theme:"primary","pre-check":e.handleUseSlaPreCheck},model:{value:e.isSlaActive,callback:function(t){e.isSlaActive=t},expression:"isSlaActive"}}),e._v("\n                    "+e._s(e.$t("m.serviceConfig['可以通过点击添加“+”或点击流程节点添加']"))+"\n                ")],1),e._v(" "),e.isSlaActive?n("div",{staticClass:"bk-sla-content"},[n("div",{staticClass:"bk-service-agreement"},[n("span",{staticClass:"bk-service-label"},[e._v(e._s(e.$t("m.serviceConfig['服务协议']"))),n("span",{staticClass:"red-star"},[e._v("*")])]),e._v(" "),n("div",{staticClass:"bk-service-agreement-list"},[e._l(e.serviceData.sla,(function(t,o){return n("div",{key:o,staticClass:"bk-agreement-content"},[n("span",{staticClass:"bk-agreement-color",style:"background-color: "+t.color}),e._v(" "),n("span",{staticClass:"bk-agreement-text",on:{click:function(n){return e.agreementTextClick(t,"edit")}}},[e._v(e._s(e.getProtocolName(t.sla_id)||e.$t('m.tickets["未设置"]')))]),e._v(" "),n("span",{staticClass:"bk-icon icon-delete",on:{click:function(n){return e.agreementCloseClick(t,o)}}})])})),e._v(" "),n("bk-button",{staticClass:"bk-sla-add",attrs:{size:"small",theme:"default",icon:"plus"},on:{click:function(t){return e.agreementTextClick({})}}})],2)]),e._v(" "),n("div",{directives:[{name:"bkloading",rawName:"v-bkloading",value:{isLoading:e.canvasDataLoading},expression:"{ isLoading: canvasDataLoading }"}],staticStyle:{height:"420px","margin-top":"10px"}},[e.canvasDataLoading?e._e():n("second-flow",{ref:"flowInfo",attrs:{"add-list":e.addList,"service-agreement-list":e.serviceData.sla,"line-list":e.lineList,"flow-info":e.previewInfo},on:{slaIconClick:e.agreementTextClick,configuNode:e.configuNode}})],1)]):e._e()])],1),e._v(" "),n("div",{staticClass:"bk-priority-btn"},[n("bk-button",{staticClass:"mr10",attrs:{theme:"primary",title:e.$t("m.slaContent['提交']"),loading:e.submitPending,disabled:e.serviceLoading},on:{click:e.submitFn}},[e._v(e._s(e.$t("m.slaContent['提交']"))+"\n            ")]),e._v(" "),n("bk-button",{staticClass:"mr10",attrs:{theme:"default",title:e.$t("m.eventdeploy['取消']")},on:{click:e.goToServiceList}},[e._v(e._s(e.$t('m.eventdeploy["取消"]'))+"\n            ")])],1)]),e._v(" "),n("bk-sideslider",{attrs:{"is-show":e.serviceAgreementIsShow,"quick-close":!0,"before-close":e.clearLastNode,width:695},on:{"update:isShow":function(t){e.serviceAgreementIsShow=t},"update:is-show":function(t){e.serviceAgreementIsShow=t}}},[n("div",{staticClass:"sideslider-header",attrs:{slot:"header"},slot:"header"},[e._v("\n            "+e._s(e.$t("m.serviceConfig['绑定服务协议']"))+"\n            "),n("div",{staticClass:"view-agreement-text",on:{click:function(t){e.viewAgreementIsShow=!0}}},[e._v(e._s(e.$t("m.serviceConfig['查看协议计时说明']")))])]),e._v(" "),n("div",{staticClass:"sideslider-content",attrs:{slot:"content"},slot:"content"},[n("bk-form",{ref:"agreementForm",attrs:{"label-width":250,"form-type":"vertical",model:e.agreementEditData,rules:e.agreementRules}},[n("bk-form-item",{staticStyle:{width:"calc(50% - 15px)"},attrs:{label:e.$t("m.serviceConfig['开始节点']"),required:!0,property:"start_node_id"}},[n("bk-select",{attrs:{placeholder:e.$t("m.serviceConfig['请选择开始计时节点']"),searchable:""},on:{change:e.getPostNodes},model:{value:e.agreementEditData.start_node_id,callback:function(t){e.$set(e.agreementEditData,"start_node_id",t)},expression:"agreementEditData.start_node_id"}},e._l(e.nodeOption,(function(e){return n("bk-option",{key:e.id,attrs:{id:e.id,name:e.name}})})),1)],1),e._v(" "),n("span",{staticClass:"bk-line-icon"}),e._v(" "),n("bk-form-item",{staticStyle:{width:"calc(50% - 15px)"},attrs:{label:e.$t("m.serviceConfig['结束节点']"),required:!0,property:"end_node_id"}},[n("bk-select",{attrs:{placeholder:e.$t("m.serviceConfig['请选择结束计时节点']"),searchable:"",loading:e.endNodeSelectLoading},model:{value:e.agreementEditData.end_node_id,callback:function(t){e.$set(e.agreementEditData,"end_node_id",t)},expression:"agreementEditData.end_node_id"}},e._l(e.endNodeOption,(function(e){return n("bk-option",{key:e.id,attrs:{id:e.id,name:e.name}})})),1)],1),e._v(" "),n("bk-form-item",{attrs:{label:e.$t("m.serviceConfig['服务协议']"),required:!0,property:"sla_id"}},[n("bk-select",{attrs:{placeholder:e.$t("m.serviceConfig['请选择服务协议']"),searchable:""},model:{value:e.agreementEditData.sla_id,callback:function(t){e.$set(e.agreementEditData,"sla_id",t)},expression:"agreementEditData.sla_id"}},[e._l(e.slaList,(function(t){return n("bk-option",{key:t.id,attrs:{id:t.id,name:t.name}},[n("span",[e._v(e._s(t.name))]),e._v(" "),n("i",{directives:[{name:"bk-tooltips",rawName:"v-bk-tooltips",value:{content:"跳转查看协议",placements:["top"]},expression:"{ content: '跳转查看协议', placements: ['top'] }"}],staticClass:"bk-icon icon-edit",on:{click:function(n){return n.stopPropagation(),e.handleEditAgreement(t)}}})])})),e._v(" "),n("div",{staticStyle:{cursor:"pointer"},attrs:{slot:"extension"},on:{click:e.handleCreateAgreement},slot:"extension"},[n("i",{staticClass:"bk-icon icon-plus-circle"}),e._v(e._s(e.$t("m.serviceConfig['跳转新建协议']"))+"\n                        ")])],2)],1),e._v(" "),n("bk-form-item",{attrs:{label:e.$t("m.serviceConfig['颜色标志设置']")}},[n("bk-color-picker",{model:{value:e.agreementEditData.color,callback:function(t){e.$set(e.agreementEditData,"color",t)},expression:"agreementEditData.color"}})],1)],1),e._v(" "),n("div",{staticStyle:{"margin-top":"20px"}},[n("bk-button",{staticStyle:{"margin-right":"10px",width:"86px"},attrs:{theme:"primary"},on:{click:function(t){return e.handleSetAgreement()}}},[e._v("确定")]),e._v(" "),n("bk-button",{staticStyle:{width:"86px"},attrs:{theme:"default"},on:{click:function(t){return e.handleCancelAgreement()}}},[e._v("取消")])],1)],1)]),e._v(" "),n("bk-dialog",{staticClass:"viewAgreeDialog",attrs:{theme:"primary",width:"1220","mask-close":!1,"cancel-text":"关闭",title:e.$t("m.serviceConfig['协议计时说明']")},model:{value:e.viewAgreementIsShow,callback:function(t){e.viewAgreementIsShow=t},expression:"viewAgreementIsShow"}},[n("div",{staticClass:"agree-img"})])],1)},i=[];o._withStripped=!0},vU3E:function(e,t,n){}}]);