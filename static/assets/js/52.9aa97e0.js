(window.webpackJsonp=window.webpackJsonp||[]).push([[52],{"5Dgz":function(t,e,i){"use strict";i("HTw/")},B5ja:function(t,e,i){"use strict";i.r(e);var o=i("EsV9"),a=i("JVbF");for(var n in a)["default"].indexOf(n)<0&&function(t){i.d(e,t,(function(){return a[t]}))}(n);i("5Dgz");var s=i("KHd+"),c=Object(s.a)(a.default,o.a,o.b,!1,null,"4dce4c28",null);c.options.__file="src/views/project/notice.vue",e.default=c.exports},EsV9:function(t,e,i){"use strict";i.d(e,"a",(function(){return o})),i.d(e,"b",(function(){return a}));var o=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"bk-itsm-service"},[i("div",{staticClass:"is-title",class:{"bk-title-left":!t.sliderStatus}},[i("p",{staticClass:"bk-come-back"},[t._v("\n            "+t._s(t.$t('m["通知配置"]'))+"\n        ")])]),t._v(" "),i("div",{staticClass:"itsm-page-content"},[i("ul",{staticClass:"bk-notice-tab"},t._l(t.remindWayList,(function(e,o){return i("li",{key:e.id,class:{"bk-check-notice":t.acticeTab===e.id},on:{click:function(i){return t.changeNotice(e,o)}}},[i("span",[t._v(t._s(e.name))])])})),0),t._v(" "),i("div",{staticClass:"bk-only-btn"},[i("bk-button",{attrs:{theme:"primary","data-test-id":"notice_button_create"},on:{click:t.addNotice}},[i("i",{staticClass:"bk-itsm-icon icon-itsm-icon-one-five"}),t._v("\n                "+t._s(t.$t("m.deployPage['新增']"))+"\n            ")]),t._v(" "),i("div",{staticClass:"bk-only-search"},[i("bk-input",{attrs:{"data-test-id":"notice_input_search",placeholder:t.$t("m['请输入模板内容']"),clearable:!0,"right-icon":"bk-icon icon-search"},on:{enter:function(e){return t.getNoticeList(1)},clear:function(e){return t.getNoticeList(1)}},model:{value:t.searchNotice,callback:function(e){t.searchNotice=e},expression:"searchNotice"}})],1)],1),t._v(" "),i("bk-table",{directives:[{name:"bkloading",rawName:"v-bkloading",value:{isLoading:t.isDataLoading},expression:"{ isLoading: isDataLoading }"}],attrs:{data:t.noticeList,size:"small"}},[i("bk-table-column",{attrs:{type:"index",label:"No.",align:"center",width:"60"}}),t._v(" "),i("bk-table-column",{attrs:{label:t.$t("m.deployPage['通知类型']"),prop:"action_name"}}),t._v(" "),i("bk-table-column",{attrs:{label:t.$t("m.slaContent['更新时间']"),prop:"update_at"}}),t._v(" "),i("bk-table-column",{attrs:{label:t.$t("m.deployPage['更新人']"),prop:"updated_by"}}),t._v(" "),i("bk-table-column",{attrs:{label:t.$t("m.deployPage['操作']"),width:"150"},scopedSlots:t._u([{key:"default",fn:function(e){return[i("bk-button",{attrs:{theme:"primary",text:""},on:{click:function(i){return t.editNotice(e.row)}}},[t._v("\n                        "+t._s(t.$t('m.deployPage["编辑"]'))+"\n                    ")]),t._v(" "),i("bk-button",{attrs:{theme:"primary",text:""},on:{click:function(i){return t.deleteNotice(e.row)}}},[t._v("\n                        "+t._s(t.$t('m.deployPage["删除"]'))+"\n                    ")])]}}])})],1),t._v(" "),i("bk-dialog",{attrs:{width:"690",theme:"primary","mask-close":!1,"auto-close":!1,"header-position":"left",title:t.isEdit?"编辑":"新建"},on:{confirm:t.submitNotice,cancel:t.closeNotice},model:{value:t.isShowEdit,callback:function(e){t.isShowEdit=e},expression:"isShowEdit"}},[i("div",{staticClass:"notice-forms"},[i("bk-form",{ref:"basicFrom",attrs:{model:t.formData,width:"700","form-type":"vertical",rules:t.rules}},[i("bk-form-item",{attrs:{label:"通知方式",required:!0,property:"noticeType"}},[i("bk-select",{attrs:{disabled:!0,searchable:""},model:{value:t.formData.noticeType,callback:function(e){t.$set(t.formData,"noticeType",e)},expression:"formData.noticeType"}},t._l(t.noticeTypeLIST,(function(t){return i("bk-option",{key:t.id,attrs:{id:t.id,name:t.name}})})),1)],1),t._v(" "),i("bk-form-item",{attrs:{label:"通知场景",required:!0,property:"noticeUserBy"}},[i("bk-select",{attrs:{disabled:!1,searchable:""},on:{selected:t.handleSelectUserBy},model:{value:t.formData.noticeUserBy,callback:function(e){t.$set(t.formData,"noticeUserBy",e)},expression:"formData.noticeUserBy"}},t._l(t.userByList,(function(t){return i("bk-option",{key:t.id,attrs:{id:t.id,name:t.name}})})),1)],1),t._v(" "),i("bk-form-item",{attrs:{label:"通知类型",required:!0,property:"noticeAction"}},[i("bk-select",{attrs:{searchable:"",loading:t.actionLoading},model:{value:t.formData.noticeAction,callback:function(e){t.$set(t.formData,"noticeAction",e)},expression:"formData.noticeAction"}},t._l(t.actionList,(function(t){return i("bk-option",{key:t.id,attrs:{id:t.id,name:t.name}})})),1)],1)],1),t._v(" "),i("editor-notice",{ref:"editorNotice",attrs:{"custom-row":t.customRow,"is-show-title":!0,"check-id":t.acticeTab,"is-show-footer":!1,"notice-info":t.formInfo},on:{closeEditor:t.closeEditor}})],1)])],1)])},a=[];o._withStripped=!0},"HTw/":function(t,e,i){},JVbF:function(t,e,i){"use strict";i.r(e);var o=i("sSkU"),a=i.n(o);for(var n in o)["default"].indexOf(n)<0&&function(t){i.d(e,t,(function(){return o[t]}))}(n);e.default=a.a},sSkU:function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var o=r(i("4d7F")),a=r(i("14Xm")),n=r(i("D3Ub")),s=r(i("Whvt")),c=r(i("0hVY"));function r(t){return t&&t.__esModule?t:{default:t}}e.default={name:"Notice",components:{editorNotice:s.default},mixins:[c.default],data:function(){return{acticeTab:"WEIXIN",isShowEdit:!1,isEdit:!1,editNoticeId:"",remindWayList:[{id:"WEIXIN",name:"企业微信"},{id:"EMAIL",name:"邮件"},{id:"SMS",name:"手机短信"}],noticeList:[],noticeTypeLIST:[{id:"WEIXIN",name:"企业微信"},{id:"EMAIL",name:"邮件"},{id:"SMS",name:"手机短信"}],userByList:[{id:"TICKET",name:"单据"},{id:"SLA",name:"SLA"},{id:"TASK",name:"任务"}],rules:{noticeType:[{required:!0,message:"必选项",trigger:"blur"}],noticeAction:[{required:!0,message:"必选项",trigger:"blur"}],noticeUserBy:[{required:!0,message:"必选项",trigger:"blur"}]},actionList:[],typeList:[],formData:{noticeType:"",noticeAction:"",noticeUserBy:""},formInfo:{},isDataLoading:!1,searchNotice:"",customRow:5,actionLoading:!1}},computed:{sliderStatus:function(){return this.$store.state.common.slideStatus}},watch:{acticeTab:{handler:function(t){this.formData.noticeType=t},immediate:!0}},mounted:function(){this.getNoticeList()},methods:{changeNotice:function(t,e){this.acticeTab=t.id,this.getNoticeList()},handleSelectUserBy:function(t){var e=this;return(0,n.default)(a.default.mark((function i(){var o,n,s,c;return a.default.wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return i.prev=0,e.actionLoading=!0,e.actionList=[],e.formData.noticeAction="",o={used_by:t},i.next=7,e.$store.dispatch("project/getAction",o);case 7:if((n=i.sent).data&&n.result)for(c in s=n.data)e.actionList.push({id:c,name:s[c]});i.next=14;break;case 11:i.prev=11,i.t0=i.catch(0),console.log(i.t0);case 14:return i.prev=14,e.actionLoading=!1,i.finish(14);case 17:case"end":return i.stop()}}),i,e,[[0,11,14,17]])})))()},getNoticeList:function(t){var e=this;this.isDataLoading=!0;var i={project_key:this.$route.query.project_id,notify_type:this.acticeTab};t&&(i.content_template__icontains=this.searchNotice),this.$store.dispatch("project/getProjectNotice",{params:i}).then((function(t){e.noticeList=t.data})).catch((function(t){console.log(t)})).finally((function(){e.isDataLoading=!1}))},submitNotice:function(){var t=this;o.default.all([this.$refs.editorNotice.$refs.wechatForm.validate(),this.$refs.basicFrom.validate()]).then((function(e){var i=t.$refs.editorNotice.formInfo,o={title_template:i.title,content_template:i.message,project_key:t.$route.query.project_id},a=t.isEdit?"project/updateProjectNotice":"project/addProjectNotice";t.isEdit&&(o.id=t.editNoticeId),o.notify_type=t.formData.noticeType,o.action=t.formData.noticeAction,o.used_by=t.formData.noticeUserBy,t.$store.dispatch(a,o).then((function(e){t.$bkMessage({message:e.message,theme:"success"}),t.isShowEdit=!1,t.getNoticeList(),t.clearFromData()})).catch((function(e){t.$bkMessage({message:e.data.message,theme:"error"})}))}))},clearFromData:function(){this.formData.noticeAction="",this.formData.noticeUserBy="",this.$refs.editorNotice.formInfo={title:"",message:""}},closeNotice:function(){this.$refs.basicFrom.clearError(),this.$refs.editorNotice.$refs.wechatForm.clearError(),this.clearFromData(),this.isShowEdit=!1},addNotice:function(){this.isEdit=!1,this.isShowEdit=!0},editNotice:function(t){this.editNoticeId=t.id,this.formData.noticeUserBy=t.used_by,this.handleSelectUserBy(t.used_by),this.formData.noticeAction=t.action,this.$refs.editorNotice.formInfo={title:t.title_template,message:t.content_template},this.isEdit=!0,this.isShowEdit=!0},deleteNotice:function(t){var e=this;this.$bkInfo({title:this.$t('m["确认要删除？"]'),confirmLoading:!0,confirmFn:function(){e.$store.dispatch("project/deleteProjectNotice",t.id).then((function(t){e.$bkMessage({message:e.$t('m["删除成功"]'),theme:"success"}),e.getNoticeList()}))}})},closeEditor:function(){this.isShowEdit=!1}}}}}]);